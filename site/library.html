<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Alt Text Library</title>

    <link rel="apple-touch-icon" sizes="180x180" href="favicon/apple-touch-icon.png">
    <link rel="icon" type="image/png" sizes="32x32" href="favicon/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="favicon/favicon-16x16.png">
    <link rel="manifest" href="favicon/site.webmanifest">
    <link rel="mask-icon" href="favicon/safari-pinned-tab.svg" color="#5bbad5">

    <meta name="apple-mobile-web-app-title" content="alt-text.org">
    <meta name="application-name" content="alt-text.org">
    <meta name="msapplication-TileColor" content="#da532c">
    <meta name="theme-color" content="#000000">

    <script src="./shared/share.js"></script>
    <script>
        async function getImageHash() {
            const fileUpload = document.getElementById('fileUpload');
            if (!fileUpload) {
                alert("'fileUpload is null or undefined!'")
                return null
            } else if (!fileUpload.files || !fileUpload.files.length || fileUpload.files.length !== 1) {
                alert("Malformed file upload files: " + JSON.stringify(fileUpload.files))
                return null
            }

            let file = fileUpload.files[0]
            let buffer = await file.arrayBuffer();
            let imgStr = btoa(new Uint8Array(buffer).reduce((data, byte) => {
                return data + String.fromCharCode(byte);
            }, ''));

            return sha256(imgStr)
        }

        async function sendHash() {
            const altText = document.getElementById('altText')
            if (!altText) {
                alert("No alt text found!")
                return
            } else if (!altText.value || !altText.value.length) {
                alert("Value not found or malformed?")
                return
            } else if (altText.value.length < 50) {
                alert("Too short!")
                return
            }

            let hash = await getImageHash()
            if (!hash) {
                alert("Couldn't hash image")
                return
            }

            let body = {
                alt_text: altText.value,
                lang: "en",
                license: "CC0"
            };
            console.log(body)

            await fetch(`/api/alt-text/img/${hash}`, {
                method: "POST",
                body: JSON.stringify(body),
                headers: {
                    'Content-Type': 'application/json'
                },
                redirect: "follow"
            }).then(async response => {
                    if (response.status === 204) {
                        const altText = document.getElementById('output')
                        altText.textContent = "Alt Text Uploaded!"
                    } else {
                        let body = await response.text()
                        altText.textContent = `Error fetching alt text: '${body}'`
                    }
                }
            ).catch(err => console.log(err))
        }

        async function fetchAltText() {
            let hash = await getImageHash();
            await fetch(`/api/alt-text/img/${hash}`, {
                method: "GET"
            }).then(async response => {
                const altText = document.getElementById('output')
                let body = JSON.parse(await response.text())

                if (response.status === 404) {
                    altText.textContent = "No alt text found for that image"
                    return
                } else if (response.status !== 200) {
                    altText.textContent = `Error fetching alt text. Status ${response.status}, Error: '${body.error}'`
                    return
                }

                console.log(body)
                altText.textContent = body.map(text => text.alt_text).join("\n");
            }).catch(err => console.log(err))
        }
    </script>
</head>
<body>
<input id="fileUpload" type="file" name="fileUpload"/>
<button id="upload-button" onclick="sendHash()">Upload Alt Text</button>
<hr/>
<label for="altText">Alt Text:</label><input id="altText" type="text" name="altText"/>
<hr/>
<button id="download-button" onclick="fetchAltText()">Fetch Alt Text</button>
<hr/>
<div id="output"></div>
</body>
</html>